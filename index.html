<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Красивые телефонные номера</title>

<style>
:root {
    --bg: #020617;
    --card: rgba(255,255,255,0.05);
    --accent: #38bdf8;
    --text: #e5e7eb;
    --muted: #94a3b8;
    --gold: #facc15;
    --green: #4ade80;
}

body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: linear-gradient(135deg, #020617, #0f172a);
    color: var(--text);
    padding: 16px;
}

.container {
    max-width: 900px;
    margin: auto;
}

h1 {
    text-align: center;
    color: var(--accent);
}

.card {
    background: var(--card);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 16px;
    margin-top: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
}

textarea {
    width: 100%;
    height: 140px;
    background: #020617;
    color: var(--text);
    border: 1px solid #1e293b;
    border-radius: 12px;
    padding: 12px;
    font-size: 16px;
}

button {
    width: 100%;
    padding: 14px;
    margin-top: 12px;
    border: none;
    border-radius: 12px;
    background: var(--accent);
    color: #020617;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
}

button.secondary {
    background: #1e293b;
    color: var(--text);
}

.number {
    background: #020617;
    padding: 12px;
    border-radius: 12px;
    margin-top: 8px;
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
}

.price {
    color: var(--green);
    font-weight: bold;
}

.highlight span {
    color: var(--gold);
    font-weight: bold;
}

.small {
    font-size: 14px;
    color: var(--muted);
}
</style>
</head>

<body>
<div class="container">
<h1>Красивые телефонные номера</h1>

<div class="card">
<p class="small">Вставь список телефонных номеров:</p>
<textarea id="input"></textarea>
<button onclick="analyze()">Анализировать</button>
<button class="secondary" onclick="exportCSV()">Экспорт в Excel</button>
</div>

<div class="card" id="output"></div>
</div>

<script>
const STORAGE_KEY = "phone_numbers_input";
const RESULT_KEY = "phone_numbers_result";
let exportData = [];

/* ---------- AUTOSAVE ---------- */
const textarea = document.getElementById("input");
textarea.value = localStorage.getItem(STORAGE_KEY) || "";

textarea.addEventListener("input", () => {
    localStorage.setItem(STORAGE_KEY, textarea.value);
});

if (localStorage.getItem(RESULT_KEY)) {
    document.getElementById("output").innerHTML = localStorage.getItem(RESULT_KEY);
}

/* ---------- ANALYZE ---------- */
function analyze() {
    const raw = textarea.value;
    const found = raw.match(/(\+7|8|7)?\d{10}/g) || [];
    const phones = found.map(normalize);

    const map = {};
    exportData = [];

    phones.forEach(p => map[p] = (map[p] || 0) + 1);

    let html = "<h2>Результаты</h2>";

    phones.forEach(num => {
        if (isBeautiful(num)) {
            const price = estimatePrice(num, map[num]);
            exportData.push({num, price});
            html += `
            <div class="number">
                <div class="highlight">${highlight(num)}</div>
                <div class="price">${price.toLocaleString()} ₽</div>
            </div>`;
        }
    });

    html += "<h3>Дубликаты</h3>";
    Object.keys(map).forEach(n => {
        if (map[n] > 1) {
            html += `<div class="number">${n} × ${map[n]}</div>`;
        }
    });

    document.getElementById("output").innerHTML = html;
    localStorage.setItem(RESULT_KEY, html);
}

/* ---------- HELPERS ---------- */
function normalize(num) {
    num = num.replace(/\D/g, "");
    if (num.startsWith("8")) num = "7" + num.slice(1);
    if (!num.startsWith("7")) num = "7" + num;
    return "+" + num;
}

function isBeautiful(num) {
    const n = num.slice(2);
    if (/^(\d)\1+$/.test(n)) return true;
    if (/(\d)\1{3}$/.test(n)) return true;
    if (n === n.split("").reverse().join("")) return true;
    if ("0123456789".includes(n.slice(-4))) return true;
    if (/(\d)\1/.test(n)) return true;
    return false;
}

function estimatePrice(num, count) {
    const n = num.slice(2);
    let price = 3000;

    if (/^(\d)\1+$/.test(n)) price += 30000;
    if (/(\d)\1{3}$/.test(n)) price += 20000;
    if (n === n.split("").reverse().join("")) price += 12000;
    if (/(\d)\1(\d)\2/.test(n)) price += 8000;
    if ("0123456789".includes(n.slice(-4))) price += 7000;

    const freq = {};
    n.split("").forEach(d => freq[d] = (freq[d] || 0) + 1);
    Object.values(freq).forEach(v => {
        if (v > 2) price += v * 1000;
    });

    if (count > 1) price += (count - 1) * 2000;

    return price;
}

function highlight(num) {
    const n = num.slice(2);
    const freq = {};
    n.split("").forEach(d => freq[d] = (freq[d] || 0) + 1);

    return "+7" + n.split("").map(d =>
        freq[d] > 1 ? `<span>${d}</span>` : d
    ).join("");
}

/* ---------- EXPORT ---------- */
function exportCSV() {
    if (!exportData.length) return alert("Нет данных");

    let csv = "Телефон,Цена\n";
    exportData.forEach(r => {
        csv += `${r.num},${r.price}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "phone_numbers.csv";
    link.click();
}
</script>

</body>
</html>
